<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>付箋ペタペタ</title>
    <link rel="stylesheet" href="css/fusenpeta.css" />
  </head>

  <body>
    <header>
      <h1>付箋ペタペタ</h1>
    </header>

    <main>
      <div id="input_area">
        <div id="fusen_area" class="area">
          <div class="fusen">付箋を貼っていく</div>
        </div>

        <div id="form_top">
          <div>
            <input type="date" id="date" />
          </div>
          <div id="save">登録</div>
        </div>
        <p>タイトル</p>
        <input type="text" id="title" value="無題" />

        <p>本文</p>
        <textarea id="text_area" cols="280">ここに記入</textarea>

        <p>背景色</p>
        <div class="color_select">
          <div>
            <select id="back_color">
              <option value="#fff7c9">黄色</option>
              <option value="#c0e4f2">水色</option>
              <option value="#d2e7bf">緑色</option>
              <option value="#f7c4d4">ピンク</option>
            </select>
          </div>
          <div class="sample_color">
            <div>背景色のサンプル</div>
          </div>
        </div>
      </div>

      <ul>
        <li id="rewrite">上書き保存</li>
        <li id="clear">1件削除</li>
        <li id="all_clear">全消し</li>
      </ul>
    </main>

    <footer></footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
      // --- グローバル変数として付箋データを格納する配列を用意 (初期化/ロード時に使う) ---
      let fusenData = [];

      // --- 付箋データをLocalStorageに保存する関数 ---
      function saveFusenData() {
        localStorage.setItem("all_fusens", JSON.stringify(fusenData));
      }

      // --- LocalStorageから付箋データをロードする関数 ---
      function loadFusenData() {
        const json = localStorage.getItem("all_fusens");
        if (json) {
          fusenData = JSON.parse(json);
        } else {
          fusenData = [];
        }
      }

      // --- 付箋を画面にレンダリング（表示）する関数 ---
      function renderFusen() {
        const fusenArea = $("#fusen_area");
        fusenArea.empty(); // 古い付箋を全てクリアしてから再描画

        fusenData.forEach((data) => {
          // 描画用のHTMLを生成
          const fusenHtml = `
      <div class="fusen" data-id="${data.id}" style="background-color: ${
            data.color
          };">
        <p class="fusen_date">${data.date}</p>
        <h3 class="fusen_title">${data.title}</h3>
        <p class="fusen_text">${data.text.substring(0, 100)}...</p>
      </div>
    `;
          fusenArea.append(fusenHtml);
        });
      }

      // ------------------------------------
      // --- ページロード時の初期設定 ---
      // ------------------------------------
      $(document).ready(function () {
        // 1. 今日の日付設定 (既存コードをDOMContentLoadedから移動)
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = ("0" + (today.getMonth() + 1)).slice(-2);
        const dd = ("0" + today.getDate()).slice(-2);
        const formattedDate = yyyy + "-" + mm + "-" + dd;
        $("#date").val(formattedDate);

        // 2. カラーセレクタの動作設定 (既存コードをDOMContentLoadedから移動)
        const selectElement = document.getElementById("back_color");
        const sampleElement = document.querySelector(".sample_color");
        const updateSampleColor = () => {
          sampleElement.style.backgroundColor = selectElement.value;
        };

        selectElement.addEventListener("change", updateSampleColor);
        updateSampleColor(); // 初期色を設定

        // 3. データロードと画面表示
        loadFusenData();
        renderFusen();
      });

      // ------------------------------------
      // --- イベントハンドラ ---
      // ------------------------------------

      // 新しい付箋を保存
      $("#save").on("click", function () {
        // フォームからデータを取得
        const newFusen = {
          // ユニークなIDを付与 (現在のタイムスタンプを簡略的に使用)
          id: Date.now(),
          date: $("#date").val(),
          title: $("#title").val(),
          text: $("#text_area").val(),
          color: $("#back_color").val(),
        };

        // データ配列に追加
        fusenData.push(newFusen);

        // LocalStorageに保存
        saveFusenData();

        // 画面に再描画
        renderFusen();

        // 入力フォームをクリア（オプション）
        $("#title").val("無題");
        $("#text_area").val("ここに記入");
      });

      // 全ての付箋を削除
      $("#all_clear").on("click", function () {
        if (confirm("全ての付箋データを削除してもよろしいですか？")) {
          fusenData = []; // データ配列を空にする
          saveFusenData(); // LocalStorageに空の配列を保存
          renderFusen(); // 画面を更新（付箋が全て消える）
        }
      });

      // 1件削除 (ここではフォームの内容をクリアする動作として修正)
      // 複数付箋の削除は複雑なので、一旦フォームのリセットに留める
      $("#clear").on("click", function () {
        $("#title").val("無題"); // タイトルをリセット
        $("#text_area").val("ここに記入"); // 本文をリセット
        // 日付、色は変更しない

        // LocalStorageのデータを削除しないように修正
      });
    </script>
  </body>
</html>
